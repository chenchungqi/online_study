{% extends 'base.html' %}
{% block title %}
    我的网站|抽奖界面
{% endblock %}
{% block nav_lottery_active %}active{% endblock %}

{% load staticfiles %}
{% block hearder_extends %}
    <link rel="stylesheet" href="{% static 'lottery.css' %}">
    <link rel="stylesheet" href="{% static 'lottery_rotate.css' %}">
    <link rel="stylesheet" href="{% static 'xcConfirm.css' %}">
    <script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/awardRotate.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/xcConfirm.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-8 col-md-9 col-lg-9">
                <div class="panel panel-default">
                    <div class="panel-heading">抽奖界面</div>
                    <div class="panel-body">
                        <div class="lottery_body" >
                            <div class="turntable-bg" style="background: url({% static 'images/turntable-bg.jpg' %})">
                                <div class="pointer"><img src="{% static 'images/pointer.png' %}" alt="pointer"/></div>
                                <div class="rotate" ><img id="rotate" src="{% static 'images/turntable.png' %}" alt="turntable"/></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="hidden-xs col-sm-4 col-md-3 col-lg-3">
                <div class="panel panel-default">
                    <div class="panel-heading">个人信息</div>
                    <div class="panel-body">
                        {% if user.is_authenticated %}
                            <ul class="user_info">
                                <li>昵称：{{ user.profile.nickname }}</li>
                                <li>能量：<span id="lotteryCount">{{ user.profile.lotteryCount }}</span></li>
                                <li>年级:{{ user.profile.grade_class }} </li>
                                <li>做题总数:{{ user.profile.question_num }} </li>
                                <li>学习时长:{{ user.display_time_diff }} </li>
                                <li><a href="#">刷新个人信息</a></li>
                            </ul>
                        {% else %}
                            <span>未登录，跳转到首页.....</span>
                            <script type="text/javascript">
                                window.location.href = '/';
                            </script>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script_extends %}
<script type="text/javascript">
$(function (){

	var rotateTimeOut = function (){
		$('#rotate').rotate({
			angle:0,
			animateTo:2160,
			duration:8000,
			callback:function (){
				alert('网络超时，请检查您的网络设置！');
			}
		});
	};
	var bRotate = false;

	var rotateFn = function (awards, angles, txt){
		bRotate = !bRotate;
		$('#rotate').stopRotate();
		$('#rotate').rotate({
			angle:0,
			animateTo:angles+1800,
			duration:8000,
			callback:function (){
				// alert(txt);
                window.wxc.xcConfirm(txt, window.wxc.xcConfirm.typeEnum.info);
				bRotate = !bRotate;
			}
		})
	};

	$('.pointer').click(function (){

		if(bRotate)return;
		// 获取用户的抽奖次数lotteryCount

        var user_lottery_count = document.getElementById('lotteryCount').innerText;
        if (parseInt(user_lottery_count)<=0){
            alert('剩余抽奖次数不足');
            return;
        }
        $.ajax({
                url: "{% url 'del_lottery_count' %}",
                type: 'GET',
                data: {

                },
                cache: false,
                success: function (data){
                    console.log(data)
                    $("#lotteryCount").text(data['last_count']);
                },
                error: function (xhr){
                    console.log(xhr)
                }
            });
        // 抽奖的伪随机代码更改位置
		var item = rnd(0,7);

		switch (item) {
			case 0:
				//var angle = [26, 88, 137, 185, 235, 287, 337];
				rotateFn(0, 337, '未中奖');
				break;
			case 1:
				//var angle = [88, 137, 185, 235, 287];
				rotateFn(1, 26, '免单4999元');
				break;
			case 2:
				//var angle = [137, 185, 235, 287];
				rotateFn(2, 88, '免单50元');
				break;
			case 3:
				//var angle = [137, 185, 235, 287];
				rotateFn(3, 137, '免单10元');
				break;
			case 4:
				//var angle = [185, 235, 287];
				rotateFn(4, 185, '免单5元');
				break;
			case 5:
				//var angle = [185, 235, 287];
				rotateFn(5, 185, '免单5元');
				break;
			case 6:
				//var angle = [235, 287];
				rotateFn(6, 235, '免分期服务费');
				break;
			case 7:
				//var angle = [287];
				rotateFn(7, 287, '提高白条额度');
				break;
		}

		console.log(item);
	});
});
function rnd(n, m){
	return Math.floor(Math.random()*(m-n+1)+n)
}
</script>
{% endblock %}